#! /bin/sh

if dmesg | grep "bootmode=sdboot" > /dev/null
then
	mount /mnt/ramdisk/
	mount /proc
	mkdir /mnt/mmc
	mount -t vfat /dev/mmcblk0p1 /mnt/mmc/
	cd /mnt/ramdisk/
	facmode setfac
	firmunpack /mnt/mmc/*.pkg
	tar xzvf setup.tar.gz
	setup/install
	exit 0
fi

if ! dmesg | grep "jffs2 filesystem" > /dev/null
then
	flash_eraseall /dev/mtd1
	mkdir /mtdblock1
	mount -t jffs2 /dev/mtdblock1 /mtdblock1
	cp -a `ls / | grep mtdblock1 -v | grep lost+found -v` /mtdblock1
	mount /proc/
	mount /mnt/ramdisk
	cd /mnt/ramdisk
	nanddump -f kernel.img -i -l 4194304 -o -s 12582912 /dev/mtd0
	flashmgr write kernel.img 0x800000 0x400000
	reboot
fi

#mount /etc and /tmpfs as tmpfs
mount /mnt/ramdisk
cp -a /etc /tmpfs /mnt/ramdisk/
mount /tmpfs
mount /etc
cp -a /mnt/ramdisk/* /
rm -rf /mnt/ramdisk/*
mount /proc/

if [ `sysparam get flashstatus` = "0" ]; then
	echo "update system configuration..."  
	update_etc upgrade
	facmode setfac
	sysparam set flashstatus 255
  reboot
else
mount /mnt/flash
	if [ "$?" != "0" ]; then		
		update_etc restore
	fi
	mount /mnt/flash2
	if [ "$?" != "0" ]; then		
		umount /mnt/flash2
		flash_eraseall /dev/mtd3
	fi
mount -a
fi

/bin/hostname Network-Camera

/usr/bin/socinst
DRIVER_DIR=/drivers
/sbin/insmod $DRIVER_DIR/cmemk.ko phys_start=0x86800000 phys_end=0x88000000 pools=1x10444800,4x1843200,13x102400,8x30720,8x10240,500x4096
/usr/bin/mapdmaq
/sbin/insmod $DRIVER_DIR/edmak.ko
/sbin/insmod $DRIVER_DIR/irqk.ko
/sbin/insmod $DRIVER_DIR/mt9d131.ko pclk_inv=1
/sbin/insmod $DRIVER_DIR/gpio.ko
/sbin/insmod $DRIVER_DIR/dm365mmap.ko

mkdir /mnt/ramdisk/imgbufmgr

mkfifo /var/run/aenc/s0/controlfifo
mkfifo /var/run/venc/s0/controlfifo
mkfifo /var/run/venc/s1/controlfifo
mkfifo /var/run/venc/s2/controlfifo
mkfifo /var/run/venc/s3/controlfifo
#mkfifo /var/run/venc/s4/controlfifo

mkfifo /var/run/recorder/controlfifo
mkfifo /var/run/ss/controlfifo

automount /mnt/auto file /etc/auto.conf

# apply patch
/mnt/flash2/patch/apply_patch_before
                                                                                
# Start daemons
run-parts -a start /etc/rcS.d

# apply patch
/mnt/flash2/patch/apply_patch_after
